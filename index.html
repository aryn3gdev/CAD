<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OKSRP CAD</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center h-screen font-sans">

<div class="bg-white rounded-xl shadow-lg p-8 w-96 text-center">
  <h1 class="text-2xl font-bold mb-6 text-blue-700">CAD Login</h1>
  <p class="text-gray-600 mb-6">Please login with Discord to access the CAD dashboard.</p>

  <button id="login-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full">
    Login with Discord
  </button>

  <p id="status" class="mt-4 text-red-500 font-semibold"></p>
</div>

<script>
const backend = "https://cad-backend-0ivi.onrender.com";
const clientId = "1471224271148810439";
const redirectUri = encodeURIComponent("https://aryn3gdev.github.io/CAD/index.html");
const scope = encodeURIComponent("identify guilds guilds.members.read");

// Check if already logged in
const token = localStorage.getItem("token");
const role = localStorage.getItem("role");
if (token && role) {
  // Redirect to proper dashboard automatically
  window.location.href = role === "dispatch" ? "dispatch.html" : "officer.html";
}

// Login button
document.getElementById("login-btn").addEventListener("click", () => {
  window.location.href = `https://discord.com/api/oauth2/authorize?client_id=${clientId}&response_type=code&redirect_uri=${redirectUri}&scope=${scope}`;
});

// Handle Discord OAuth redirect
async function handleLogin() {
  const params = new URLSearchParams(window.location.search);
  const code = params.get("code");
  if (!code) return;

  document.getElementById("status").innerText = "Authenticating...";

  try {
    const res = await fetch(`${backend}/auth`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ code })
    });

    const data = await res.json();

    if (!data.allowed) {
      document.getElementById("status").innerText = "Access Denied.";
      return;
    }

    // Save token + role + discord info
    localStorage.setItem("token", "loggedin"); // simple placeholder
    localStorage.setItem("role", data.dispatch ? "dispatch" : "officer");
    localStorage.setItem("discordName", data.discordName || "Unknown");
    localStorage.setItem("discordID", data.discordID || "Unknown");

    // Redirect
    if (data.dispatch) window.location.href = "dispatch.html";
    else window.location.href = "officer.html";

  } catch (err) {
    console.error(err);
    document.getElementById("status").innerText = "Login failed. Please try again.";
  }
}

// Run on page load
handleLogin();
</script>
</body>
</html>
