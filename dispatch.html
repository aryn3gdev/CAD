<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ERLC CAD - Dispatch</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans flex flex-col items-center p-4">

<div class="w-full max-w-5xl">
  <div class="flex justify-between items-center mb-4">
    <h1 class="text-2xl font-bold text-blue-700">Dispatch Dashboard</h1>
    <div>
      <span id="discord-info" class="mr-4 font-medium"></span>
      <select id="settings-dropdown" class="border rounded p-1">
        <option value="switchRole">Switch Role</option>
        <option value="changeCallsign" disabled>Change Callsign</option>
      </select>
    </div>
  </div>

  <!-- Units table -->
  <div class="overflow-x-auto mb-6">
    <table class="min-w-full bg-white rounded shadow">
      <thead>
        <tr class="bg-blue-600 text-white">
          <th class="px-4 py-2">Callsign</th>
          <th class="px-4 py-2">Discord Name</th>
          <th class="px-4 py-2">Discord ID</th>
          <th class="px-4 py-2">Status</th>
        </tr>
      </thead>
      <tbody id="units-table" class="text-center"></tbody>
    </table>
  </div>

  <!-- 911 calls -->
  <div>
    <h2 class="text-xl font-bold mb-2">911 Calls</h2>
    <ul id="calls-list" class="bg-white rounded shadow p-2 max-h-64 overflow-y-auto"></ul>
  </div>
</div>

<script>
const ws = new WebSocket("wss://cad-backend-0ivi.onrender.com");

// Client-side storage for units and calls
let units = [];
let calls = [];

// Check login
const token = localStorage.getItem("token");
const role = localStorage.getItem("role");
if (!token || !role || role !== "dispatch") {
  window.location.href = "index.html";
}

// Show Discord info
document.getElementById("discord-info").innerText =
  `${localStorage.getItem("discordName")} (${localStorage.getItem("discordID")})`;

// Sorting utility
function sortUnits(units) {
  const order = ["10-99","10-8","10-11","10-80","10-50","10-60","10-7"];
  return units.sort((a,b) => {
    const aIndex = order.indexOf(a.status) !== -1 ? order.indexOf(a.status) : order.length;
    const bIndex = order.indexOf(b.status) !== -1 ? order.indexOf(b.status) : order.length;
    return aIndex - bIndex;
  });
}

// Render units table
function renderUnits() {
  const tbody = document.getElementById("units-table");
  tbody.innerHTML = "";
  sortUnits(units).forEach(u => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="px-4 py-2">${u.callsign}</td>
      <td class="px-4 py-2">${u.discordName}</td>
      <td class="px-4 py-2">${u.discordID}</td>
      <td class="px-4 py-2 font-bold ${u.status==="10-99"?"text-red-600":u.status==="10-8"?"text-green-600":"text-gray-800"}">${u.status}</td>
    `;
    tbody.appendChild(tr);
  });
}

// Render 911 calls
function renderCalls() {
  const ul = document.getElementById("calls-list");
  ul.innerHTML = "";
  calls.forEach(c => {
    const li = document.createElement("li");
    li.className = "border-b p-2";
    li.textContent = `[${c.timestamp}] ${c.caller}: ${c.info} (${c.status})`;
    ul.appendChild(li);
  });
}

// WebSocket events
ws.addEventListener("open", () => console.log("Connected to CAD WebSocket"));

ws.addEventListener("message", (event) => {
  const data = JSON.parse(event.data);

  if (data.type === "initialData") {
    // Replace local arrays with backend-provided data
    units = data.units || [];
    calls = data.calls || [];
    renderUnits();
    renderCalls();

  } else if (data.type === "statusUpdate") {
    const idx = units.findIndex(u => u.callsign === data.callsign);
    if (idx >= 0) units[idx] = data;
    else units.push(data);
    renderUnits();

  } else if (data.type === "911Call") {
    calls.push(data);
    renderCalls();
  }
});

// Settings dropdown
document.getElementById("settings-dropdown").addEventListener("change", (e) => {
  if (e.target.value === "switchRole") {
    localStorage.removeItem("role");
    localStorage.removeItem("token");
    window.location.href = "index.html";
  }
});
</script>
</body>
</html>
