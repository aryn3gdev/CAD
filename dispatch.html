<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ERLC CAD - Dispatch</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">

<!-- Navbar -->
<div class="flex justify-between items-center p-4 bg-blue-700 text-white shadow">
  <h1 class="text-xl font-bold">ERLC Dispatch CAD</h1>
  <input type="text" id="search-box" placeholder="Search units..." class="rounded px-2 py-1 text-black w-64" />
</div>

<!-- Units Table -->
<div class="p-4 mb-6">
  <h2 class="font-bold mb-2 text-lg">Units</h2>
  <table class="min-w-full bg-white rounded shadow overflow-hidden">
    <thead class="bg-gray-200">
      <tr>
        <th class="py-2 px-4 text-left">Callsign</th>
        <th class="py-2 px-4 text-left">Discord Name</th>
        <th class="py-2 px-4 text-left">Discord ID</th>
        <th class="py-2 px-4 text-left">Status</th>
      </tr>
    </thead>
    <tbody id="unit-list">
      <!-- Live rows inserted here -->
    </tbody>
  </table>
</div>

<!-- 911 Calls Panel -->
<div class="p-4">
  <h2 class="font-bold mb-2 text-lg">911 Calls</h2>
  <table class="min-w-full bg-white rounded shadow overflow-hidden">
    <thead class="bg-red-200">
      <tr>
        <th class="py-2 px-4 text-left">Call ID</th>
        <th class="py-2 px-4 text-left">Caller</th>
        <th class="py-2 px-4 text-left">Info / Location</th>
        <th class="py-2 px-4 text-left">Status</th>
        <th class="py-2 px-4 text-left">Timestamp</th>
      </tr>
    </thead>
    <tbody id="calls-list">
      <!-- Incoming calls will appear here -->
    </tbody>
  </table>
</div>

<script>
  // ===== Units Table =====
  const unitList = document.getElementById('unit-list');
  let units = []; // live units

  document.getElementById('search-box').addEventListener('input', e => {
    renderUnits(e.target.value.toLowerCase());
  });

  function sortPriority(u) {
    if (u.status === '10-99') return 0;
    if (u.status === '10-8') return 1;
    if (['10-11','10-80','10-50','10-99A'].includes(u.status)) return 2;
    if (u.status === '10-7') return 3;
    return 4;
  }

  function renderUnits(search = '') {
    unitList.innerHTML = '';
    units
      .filter(u => 
        u.callsign.toLowerCase().includes(search) ||
        u.discordName.toLowerCase().includes(search) ||
        u.discordID.includes(search)
      )
      .sort((a,b) => sortPriority(a)-sortPriority(b))
      .forEach(u => {
        const row = document.createElement('tr');
        row.classList.add('border-b', 'hover:bg-gray-100');
        row.innerHTML = `
          <td class="py-2 px-4">${u.callsign}</td>
          <td class="py-2 px-4">${u.discordName || 'Unknown'}</td>
          <td class="py-2 px-4">${u.discordID || 'Unknown'}</td>
          <td class="py-2 px-4 font-semibold">${u.status}</td>
        `;
        unitList.appendChild(row);
      });
  }

  // ===== 911 Calls Table =====
  const callsList = document.getElementById('calls-list');
  let calls = []; // live 911 calls

  function renderCalls() {
    callsList.innerHTML = '';
    calls.forEach(c => {
      const row = document.createElement('tr');
      row.classList.add('border-b', 'hover:bg-gray-50');
      row.innerHTML = `
        <td class="py-2 px-4">${c.id}</td>
        <td class="py-2 px-4">${c.caller}</td>
        <td class="py-2 px-4">${c.info}</td>
        <td class="py-2 px-4 font-semibold">${c.status}</td>
        <td class="py-2 px-4">${c.timestamp}</td>
      `;
      callsList.appendChild(row);
    });
  }

  // ===== WebSocket for live updates =====
  const socket = new WebSocket('wss://cad-backend-0ivi.onrender.com'); // replace with your WS

  socket.addEventListener('open', () => console.log('Dispatch connected to WebSocket'));

  socket.addEventListener('message', e => {
    const msg = JSON.parse(e.data);

    // Unit status updates
    if (msg.type === 'statusUpdate') {
      const idx = units.findIndex(u => u.callsign === msg.callsign);
      if (idx >= 0) units[idx] = msg;
      else units.push(msg);
      renderUnits(document.getElementById('search-box').value.toLowerCase());
    }

    // Incoming 911 calls
    if (msg.type === '911Call') {
      calls.push(msg);
      renderCalls();
    }

    // Optionally, implement status change for 911 (Responding / Closed) via buttons later
  });
</script>
</body>
</html>
